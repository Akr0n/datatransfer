name: PROD - Test & Release Python Script

on:
  push:
    branches:
      - main

permissions:
  contents: write
  pull-requests: read
  
jobs:
  release-job:
    runs-on: windows-latest        
    steps:
      - name: Check Python version
        run: |
          python --version
          where python
          
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0   # serve per avere tutta la history

      - name: Check if the last commit is a merge from develop
        id: check_merge
        run: |
          # SHA dell'ultimo commit su main
          $LAST_COMMIT = (git rev-parse HEAD).Trim()
          Write-Output "⚠️ HEAD: $LAST_COMMIT"

          # conta i parent (se sono 2 parent -> merge commit)
          $PARENTS = (git rev-list --parents -n 1 $LAST_COMMIT).Split(" ")
          Write-Output "⚠️ Parents: $PARENTS"

          $parts = $PARENTS -split ' '
          if ($parts.Count -ne 3) {
            Write-Output "❌ The last commit is not a merge from develop. Stopping the workflow."
            "MERGE_FROM_DEVELOP=false" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8
            exit 0
          }

          # parent SHAs (i due parent dopo lo SHA del merge commit)
          $parent1 = $parts[1]
          $parent2 = $parts[2]

          # assicuriamoci di avere il riferimento origin/develop aggiornato
          git fetch origin develop

          $developSHA = (git rev-parse origin/develop).Trim()
          Write-Output "⚠️ origin/develop SHA: $developSHA"

          if ($parent1 -eq $developSHA -or $parent2 -eq $developSHA) {
            Write-Output "✅ The last commit is a merge from develop."
            "MERGE_FROM_DEVELOP=true" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8
          } else {
            Write-Output "❌ The last commit does not contain develop as a parent. Stopping the workflow."
            "MERGE_FROM_DEVELOP=false" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8
            exit 0
          }
      
      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-dev.txt

      - name: Run tests
        run: |
          pytest tests/ -v --cov=datatrasnfer --cov-report=term-missing

      - name: Create usage instructions
        run: |
          echo "# DataTransfer - PostgreSQL Migration Tool" > USAGE.txt
          echo "" >> USAGE.txt
          echo "## Utilizzo:" >> USAGE.txt
          echo "python datatrasnfer.py" >> USAGE.txt
          echo "" >> USAGE.txt
          echo "## Configurazione:" >> USAGE.txt
          echo "Modifica i dizionari 'source_conf' e 'target_conf' nel file" >> USAGE.txt
          echo "per specificare i dati di connessione ai database PostgreSQL." >> USAGE.txt
          echo "" >> USAGE.txt
          echo "## Parametri della funzione migrate_table():" >> USAGE.txt
          echo "- source_conf   : Configurazione database origine" >> USAGE.txt
          echo "- target_conf   : Configurazione database destinazione" >> USAGE.txt
          echo "- src_schema    : Schema della tabella origine" >> USAGE.txt
          echo "- src_table     : Nome della tabella origine" >> USAGE.txt
          echo "- tgt_schema    : Schema della tabella destinazione" >> USAGE.txt
          echo "- tgt_table     : Nome della tabella destinazione" >> USAGE.txt
          echo "- chunk_size    : Numero di record per chunk (default: 500)" >> USAGE.txt
          echo "" >> USAGE.txt
          echo "## Requisiti:" >> USAGE.txt
          echo "- Python 3.6+" >> USAGE.txt
          echo "- PostgreSQL" >> USAGE.txt
          echo "- psycopg2 (vedi requirements.txt)" >> USAGE.txt

      - name: Get last dev tag
        id: get_tag
        run: |
          # elenco tutti i tag e prendo l’ultimo che finisce con -dev
          git fetch --tags
          $lastDevTag = git tag --list "v*-dev" | Sort-Object {[version]($_.TrimStart("v") -replace "-dev","")} -Descending | Select-Object -First 1
          if (-not $lastDevTag) {
            Write-Error "❌ No dev tag found!"
            exit 1
          }

          Write-Output "✅ Last dev tag found: $lastDevTag"

          # tolgo il suffisso -dev
          $releaseVersion = $lastDevTag -replace "-dev",""
          Write-Output "⚠️ Versione che verrà usata --> $releaseVersion"
          $releaseTag = "$releaseVersion"

          "release_tag=$releaseTag" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8
          "release_version=$releaseVersion" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8

      - name: Create and push tag
        run: |
          git config --global user.email "federico.bot@gmail.com"
          git config --global user.name "Akr0n"
          git tag ${{ env.release_tag }}
          git push origin ${{ env.release_tag }}

      - name: Fetch tag locally and verify
        run: |
          echo "Fetching all tags from remote..."
          git fetch origin --tags
          
          echo "Verifying tag ${{ env.release_tag }} exists locally..."
          if (git tag --list | Select-String -Pattern "^${{ env.release_tag }}$") {
            Write-Output "✅ Tag ${{ env.release_tag }} successfully created and available locally"
          } else {
            Write-Output "❌ Tag ${{ env.release_tag }} not found locally"
            exit 1
          }
          
          echo "All local tags:"
          git tag --list
        
      - name: Generate changelog
        id: changelog
        uses: mikepenz/release-changelog-builder-action@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Release with changelog and assets
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.release_tag }}
          name: Release ${{ env.release_tag }}
          body: ${{ steps.changelog.outputs.changelog }}
          files: |
            ./datatrasnfer.py
            ./USAGE.txt
            ./README.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
